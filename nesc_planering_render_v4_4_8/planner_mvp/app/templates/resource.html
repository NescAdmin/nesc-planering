<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Resursvy</title>
  <link rel="stylesheet" href="/static/css/app.css"/>
</head>
<body>
<div class="topbar">
  <div class="brand">Planner MVP</div>
  <div class="nav">
    <a href="/">Resursvy</a>
    <a href="/projects">Projekt</a>
    <a href="/timeoff">Frånvaro</a>
  </div>
  <div class="user">Inloggad (dev): {{active_user.name}} (#{{active_user.id}})</div>
</div>

<div class="container">
  <div class="pagehead">
    <div>
      <h1>Resursvy – vecka {{ ws.isocalendar().week }} ({{ ws.date().isoformat() }})</h1>
      <div class="muted">Veckovy: 60 min snap. Dra block till exakt timslot. Överlappar block/ledighet markeras med röd kontur.</div>
    </div>
    <div class="pagehead-actions">
      <a class="btn" href="/?week={{ prev_week }}">← Föregående</a>
      <a class="btn" href="/?week={{ next_week }}">Nästa →</a>
    </div>
  </div>

  <div class="resource-grid">
    <div class="rg-header rg-person">Person</div>
    <div class="rg-header rg-time">Tid</div>
    {% for d in days %}
      <div class="rg-header rg-day">
        {{ ["Mån","Tis","Ons","Tor","Fre"][loop.index0] }}
        <div class="muted">{{ d.date().isoformat() }}</div>
      </div>
    {% endfor %}

    {% for person in people %}
      {% set uname = users.get(person.user_id).name if users.get(person.user_id) else ("User "+person.user_id|string) %}

      <div class="rg-person-cell">
        <div class="person-name">{{ uname }}</div>
        <div class="muted">{{ person.work_start }}–{{ person.work_end }}</div>
        {% if timeoffs.get(person.id) %}
          <div class="badge warn">Har frånvaro</div>
        {% endif %}
      </div>

      <div class="rg-time-axis" style="height: {{grid_height}}px">
        {% for h in hour_slots %}
          <div class="time-label" style="top: {{ (h - start_hour) * slot_px }}px">{{ "%02d:00"|format(h) }}</div>
        {% endfor %}
      </div>

      {% for d in days %}
        {% set day_iso = d.date().isoformat() %}
        <div class="rg-day-cell">
          <div class="day-col" style="height: {{grid_height}}px" data-person="{{person.id}}" data-day="{{day_iso}}">
            {# hour slots for drop targets #}
            {% for h in hour_slots %}
              {% set start_dt = d.replace(hour=h, minute=0, second=0, microsecond=0).isoformat() %}
              <div class="slot" style="top: {{ (h - start_hour) * slot_px }}px; height: {{slot_px}}px"
                   data-person="{{person.id}}" data-start="{{start_dt}}"></div>
            {% endfor %}

            {# timeoff overlays #}
            {% for s in timeoff_spans.get((person.id, day_iso), []) %}
              <div class="timeoff-band" style="top: {{s.top}}px; height: {{s.height}}px" title="{{s.kind}} {{s.note}}"></div>
            {% endfor %}

            {# scheduled blocks #}
            {% for it in layout_by_pd.get((person.id, day_iso), []) %}
              {% set b = it.block %}
              <div class="event {{'conflict' if it.conflict else ''}}"
                   draggable="true"
                   data-block-id="{{b.id}}"
                   style="top: {{it.top}}px; height: {{it.height}}px; left: {{it.left}}%; width: {{it.width}}%; background: {{it.proj.color if it.proj else '#64748b'}}">
                <div class="event-title">{{ it.wi.title if it.wi else 'WorkItem' }}</div>
                <div class="event-meta">
                  {{ b.start.strftime("%H:%M") }}–{{ b.end.strftime("%H:%M") }}
                  <a class="event-link" href="/workitems/{{b.work_item_id}}">detalj</a>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    {% endfor %}
  </div>
</div>

<script src="/static/js/dnd_calendar.js"></script>
</body>
</html>
