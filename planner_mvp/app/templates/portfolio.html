<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Tidschema – Resursplanering</title>
  <link rel="stylesheet" href="/static/css/app.css"/>
</head>
<body>
{% include "partials_topbar.html" %}

<div class="container wide">
  <div class="pagehead">
    <div>
      <h1>Tidschema – {{company.name}}</h1>
    </div>
    <div class="pagehead-actions">
      <div class="navgrp">
        <a class="btn icon" title="Föregående" href="/?view={{view}}&ref={{prev_ref}}{% if selected_person_id is not none %}&person={{selected_person_id}}{% endif %}">←</a>
        <a class="btn icon" title="Idag" href="/?view={{view}}&ref={{today_ref}}{% if selected_person_id is not none %}&person={{selected_person_id}}{% endif %}">Idag</a>
        <a class="btn icon" title="Nästa" href="/?view={{view}}&ref={{next_ref}}{% if selected_person_id is not none %}&person={{selected_person_id}}{% endif %}">→</a>
      </div>

      <div class="inline" style="gap:8px; align-items:center; margin-top:0">
        <input id="refPicker" type="date" value="{{ref.isoformat()}}" style="width:auto; min-width: 150px" />
      </div>

      <button class="btn icon" id="toggleSidebar" type="button" title="Dölj/visa sidopanel">☰</button>

      <div class="seg">
        <a class="segbtn {{'active' if view=='day' else ''}}" href="/?view=day&ref={{ref.isoformat()}}{% if selected_person_id is not none %}&person={{selected_person_id}}{% endif %}">Dag</a>
        <a class="segbtn {{'active' if view=='week' else ''}}" href="/?view=week&ref={{ref.isoformat()}}{% if selected_person_id is not none %}&person={{selected_person_id}}{% endif %}">Vecka</a>
        <a class="segbtn {{'active' if view=='month' else ''}}" href="/?view=month&ref={{ref.isoformat()}}{% if selected_person_id is not none %}&person={{selected_person_id}}{% endif %}">Månad</a>
      </div>
    </div>
  </div>

  <div class="layout" id="layout">
    <div class="sidebar card">
      <div class="sidecols">
        <div class="sidecol">
          <h2>Personer</h2>
<input id="personSearch" type="text" placeholder="Sök person…" class="filter-input"/>
          <div class="person-list">
            <a class="person-item {{'active' if selected_person_id is none else ''}}" href="/?view={{view}}&ref={{ref.isoformat()}}">Alla</a>
            {% for p in people_all %}
              {% set u = users.get(p.user_id) %}
              <a class="person-item {{'active' if selected_person_id==p.id else ''}}" href="/?view={{view}}&ref={{ref.isoformat()}}&person={{p.id}}">
                {{u.name if u else ("User " + (p.user_id|string))}}
              </a>
            {% endfor %}
          </div>
        </div>

        <div class="sidecol">
          <div class="sidehead">
            <h2>Projekt</h2>
            <button class="btn mini" id="toggleProjects" type="button" data-count="{{projects|length}}">Dölj ({{projects|length}})</button>
          </div>
          <input id="projectSearch" type="text" placeholder="Sök projekt…" class="filter-input"/>
          <label class="chk"><input id="overOnly" type="checkbox"/> Visa bara överbelagda personer</label>
<button class="btn mini" id="clearFilters" type="button" style="margin-top:6px;background:#64748b">Rensa filter</button>

          <div class="projects-panel" id="projectsPanel"><div class="project-list">
            {% for p in projects %}
              {% set t = proj_totals.get(p.id, {}) %}
              {% set scope = (t.get('scope',0) or 0) %}
              {% set planned = (t.get('planned',0) or 0) %}
              {% set over = (t.get('over',0) or 0) %}
              <div class="project-chip" draggable="true"
                   data-project-id="{{p.id}}"
                   style="border-left: 10px solid {{p.color}}">

                <div class="projline">
                  <span class="proj-name" title="{{p.name}}">{{p.name}}</span>
                  {% if over > 0 %}
                    <span class="proj-badge over">+{{"%.1f"|format(over/60)}}h</span>
                  {% else %}
                    <span class="proj-badge ok">{{"%.1f"|format((scope-planned)/60)}}h kvar</span>
                  {% endif %}
                  {% if (p.budget_minutes or 0) == 0 and (proj_items.get(p.id, [])|length) > 0 %}
                    <button class="chip-expand" type="button" title="Visa enheter" data-project-id="{{p.id}}">▾</button>
                  {% endif %}
                </div>

                <div class="proj-details" data-proj-details="{{p.id}}" style="display:none">
                  <div class="proj-meta-full">
                    {% if (p.budget_minutes or 0) > 0 %}
                      Budget: {{"%.1f"|format(scope/60)}}h • Planerat: {{"%.1f"|format(planned/60)}}h •
                    {% else %}
                      Scope: {{"%.1f"|format(scope/60)}}h • Planerat: {{"%.1f"|format(planned/60)}}h •
                    {% endif %}
                    {% if over > 0 %}<span class="over">Överskridet: +{{"%.1f"|format(over/60)}}h</span>{% else %}<span class="ok">Kvar: {{"%.1f"|format((scope-planned)/60)}}h</span>{% endif %}
                  </div>
                </div>

                <div class="project-items" data-project-items="{{p.id}}" style="display:none">
                  {% for wi in proj_items.get(p.id, []) %}
                    {% set rem = wi.remaining %}
                    <div class="workitem-chip" draggable="true"
                         data-project-id="{{p.id}}"
                         data-workitem-id="{{wi.id}}"
                         data-budget-minutes="{{wi.budget}}">
                      <div class="wi-title">{{wi.title}}</div>
                      <div class="wi-meta muted">
                        Budget: {{"%.1f"|format((wi.budget or 0)/60)}}h • Planerat: {{"%.1f"|format((wi.planned or 0)/60)}}h •
                        {% if rem < 0 %}
                          <span class="wi-over">Överskridet: +{{"%.1f"|format((-rem)/60)}}h</span>
                        {% else %}
                          Kvar: {{"%.1f"|format((rem or 0)/60)}}h
                        {% endif %}
                      </div>
                    </div>
                  {% endfor %}
                </div>

              </div>
            {% endfor %}
          </div>
</div>
      </div>
    </div>

    </div>

    <div class="main card">
{% if view == 'day' %}
        <div class="muted" style="margin:0 0 12px">Vecka {{periods[0].start|dm}} – {{periods[-1].end|dm}}</div>
      {% endif %}

      {% if view in ['day','week','month'] %}
        <div class="hscroll">
        <div class="portfolio-timeline" style="grid-template-columns: var(--person-col, 220px) 1fr;">
          <div class="pt-head pt-person">Person</div>
          <div class="pt-head pt-axis">
            <div class="pt-axis-grid" style="grid-template-columns: repeat({{periods|length}}, 1fr);">
              {% for per in periods %}
                <div class="pt-axis-cell">
                  <div>{{per.label}}</div>
                  <div class="muted">
                    {{per.start|dm}}{% if per.start != per.end %} – {{per.end|dm}}{% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>

          {% for person in people %}
            {% set u = users.get(person.user_id) %}
            <div class="pt-person-cell" data-person-row="{{person.id}}">
              <div class="person-name">
                <a class="person-link" href="/?view={{view}}&ref={{ref.isoformat()}}&person={{person.id}}">{{u.name if u else ("User "+person.user_id|string)}}</a>
                {% set avgp = row_avg.get(person.id, 0) %}
                {% set peakp = row_peak.get(person.id, avgp) %}
                <span class="person-pct {{'over' if peakp>100 else ''}}" title="Planerad (max i perioden): {{peakp}}% • Snitt: {{avgp}}%">{{peakp}}%</span>
              </div>
              <div class="muted">{{person.work_start}}–{{person.work_end}}</div>
            </div>

            {% set lanes = timeline_lanes.get(person.id, 1) %}
            {% set unitlines = timeline_unitlines.get(person.id, 0) %}
            <div class="pt-row" data-person-row="{{person.id}}" style="--pt-cols: {{periods|length}}; --pt-lanes: {{lanes}}; --pt-unitlines: {{unitlines}};">
              <div class="pt-bg" style="grid-template-columns: repeat({{periods|length}}, 1fr);">
                {% for per in periods %}
                  {% set pi = loop.index0 %}
                  {% set sumv = cell_sum.get((person.id, pi), 0) %}
                  <div class="pt-cell dropcell {{'over' if sumv>100 else ''}} {{'timeoff' if off_cells.get((person.id, pi)) else ''}}"
                       data-person="{{person.id}}"
                       data-pi="{{pi}}"
                       data-start="{{per.start}}"
                       data-end="{{per.end}}">
                    <div class="pt-cell-top">
                      {% if off_cells.get((person.id, pi)) %}<span class="tag">Ledig</span>{% endif %}
                      <span class="pct {{'pct-over' if sumv>100 else ''}}">{{sumv}}%</span>
                    </div>
                  </div>
                {% endfor %}
              </div>

              {# Unit tags overlay: drawn ABOVE bars so they never get hidden behind project allocations #}
              <div class="pt-units" style="grid-template-columns: repeat({{periods|length}}, 1fr);">
                {% for per in periods %}
                  {% set pi = loop.index0 %}
                  <div class="pt-unitcell">
                    {% for tag in cell_unit_tags.get((person.id, pi), []) %}
                      {% set proj = projects_by_id.get(tag.project_id) %}
                      {% set h = ("%.1f"|format((tag.minutes or 0)/60))|replace('.0','') %}
                      <div class="unit-tag" draggable="true"
                           data-unitalloc-id="{{tag.id}}"
                           data-project-id="{{tag.project_id}}"
                           data-workitem-id="{{tag.work_item_id}}"
                           data-ua-start="{{tag.ua_start}}"
                           data-ua-end="{{tag.ua_end}}"
                           data-ua-total-minutes="{{tag.ua_minutes}}"
                           style="border-left: 6px solid {{proj.color if proj else '#94a3b8'}}">
                        <span class="unit-label">{{ (proj.name if proj else ("Projekt " ~ tag.project_id)) ~ " - " ~ (tag.title or "") ~ " " ~ h ~ "h" }}</span>
                        <span class="unit-hours">{{h}}h</span>
                        <span class="u-resize" title="Dra för att ändra timmar">⠿</span>
                      </div>
                    {% endfor %}
                  </div>
                {% endfor %}
              </div>

              <div class="pt-bars" style="grid-template-columns: repeat({{periods|length}}, 1fr); grid-template-rows: repeat({{lanes}}, 26px);">
                {% for seg in timeline_segments.get(person.id, []) %}
                  {% if seg.type == 'adhoc' %}
                    <div class="alloc pt-alloc adhoc"
                         draggable="true"
                         data-type="adhoc"
                         data-adhoc-id="{{seg.id}}"
                         data-start="{{seg.start_date}}"
                         data-end="{{seg.end_date}}"
                         data-start-pi="{{seg.start_pi}}"
                         data-end-pi="{{seg.end_pi}}"
                         data-percent="{{seg.percent}}"
                         data-title="{{seg.title|e}}"
                         style="grid-column: {{seg.start_pi + 1}} / {{seg.end_pi + 2}}; grid-row: {{seg.lane + 1}}; background: {{seg.color}}">
                      <span class="alloc-handle left" title="Ändra start"></span>
                      <span class="alloc-handle right" title="Ändra slut"></span>
                      <span class="alloc-label">{{seg.title}} – {{seg.percent}}%</span>
                    </div>
                  {% else %}
                    {% set proj = projects_by_id.get(seg.project_id) %}
                    <div class="alloc pt-alloc"
                         draggable="true"
                         data-type="alloc"
                         data-alloc-id="{{seg.id}}"
                         data-project-id="{{seg.project_id}}"
                         data-start="{{seg.start_date}}"
                         data-end="{{seg.end_date}}"
                         data-start-pi="{{seg.start_pi}}"
                         data-end-pi="{{seg.end_pi}}"
                         data-percent="{{seg.percent}}"
                         style="grid-column: {{seg.start_pi + 1}} / {{seg.end_pi + 2}}; grid-row: {{seg.lane + 1}}; background: {{proj.color if proj else '#999'}}">
                      <span class="alloc-handle left" title="Ändra start"></span>
                      <span class="alloc-handle right" title="Ändra slut"></span>
                      <span class="alloc-label">{{proj.name if proj else ("Projekt "+seg.project_id|string)}} – {{seg.percent}}%</span>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  window.__projects = [
    {% for p in projects %}
      { id: {{p.id}}, name: {{p.name|tojson}}, color: {{p.color|tojson}} },
    {% endfor %}
  ];
  window.__view = "{{view}}";
  window.__ref = "{{ref.isoformat()}}";
  window.__selectedPersonId = {{selected_person_id if selected_person_id is not none else 'null'}};
</script>

<script src="/static/js/dnd_alloc.js"></script>

<script>
  // date picker navigation
  (function(){
    const el = document.getElementById('refPicker');
    if(!el) return;
    el.addEventListener('change', () => {
      const v = el.value;
      if(!v) return;
      const params = new URLSearchParams(window.location.search);
      params.set('ref', v);
      params.set('view', (window.__view || 'week'));
      if(window.__selectedPersonId){ params.set('person', String(window.__selectedPersonId)); }
      window.location.href = '/?' + params.toString();
    });
  })();
</script>


<script>
(function(){
  const btn = document.getElementById('toggleProjects');
  const panel = document.getElementById('projectsPanel');
  if(!btn || !panel) return;
  const count = parseInt(btn.getAttribute('data-count') || '0', 10);
  const threshold = 8;
  function setLabel(collapsed){
    btn.textContent = (collapsed ? `Visa (${count})` : `Dölj (${count})`);
  }
  if(count > threshold){
    panel.classList.add('collapsed');
    setLabel(true);
  }
  btn.addEventListener('click', () => {
    const collapsed = panel.classList.toggle('collapsed');
    setLabel(collapsed);
  });
})();
</script>

</body>
</html>
