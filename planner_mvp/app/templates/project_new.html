<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Nytt projekt</title>
  <link rel="stylesheet" href="/static/css/app.css"/>
</head>
<body>
{% include "partials_topbar.html" %}
<div class="container">
  <div class="pagehead">
    <div>
      <h1>Skapa nytt projekt</h1>
      <div class="muted">Standard: skapa projekt med total budget (timmar). Du kan även välja enhets-scope om du vill planera på enhetsnivå.</div>
    </div>
  </div>

  <form method="post" action="/projects/new" class="card">
    {% if error %}
      <div class="alert danger" style="margin-bottom:10px;">{{error}}</div>
    {% endif %}
    <label>Projektnamn</label>
    <input name="name" placeholder="Porsche" required value="{{prefill_name or ''}}"/>

    <h2>Projektläge</h2>
    <div class="row" style="gap:16px; align-items:center;">
      <label class="chk"><input type="radio" name="mode" value="budget" {% if (prefill_mode or 'budget')=='budget' %}checked{% endif %}/> Budget (timmar)</label>
      <label class="chk"><input type="radio" name="mode" value="units" {% if (prefill_mode or '')=='units' %}checked{% endif %}/> Enheter (scope)</label>
    </div>

    <div id="budgetBox" style="margin-top:10px;">
      <label>Budget (timmar)</label>
      <input name="budget_hours" type="number" min="0" step="0.5" placeholder="120" value="{{prefill_budget_hours or ''}}"/>
      <div class="muted">Budget används när du vill följa ett projekt i tid utan att lägga in enheter.</div>
    </div>

    <div id="unitsBox" style="margin-top:14px;">
    <h2>Projektets innehåll (scope)</h2>
    <table class="table">
      <thead><tr><th>Enhet</th><th>Min/enhet</th><th>Antal</th><th>Tid (h)</th></tr></thead>
      <tbody>
        {% for u in units %}
          <tr>
            <td>{{u.icon}} {{u.name}}<input type="hidden" name="unit_type_ids" value="{{u.id}}"/></td>
            <td>{{u.default_minutes}}</td>
            <td><input class="qty" type="number" name="quantities" value="0" min="0" data-min="{{u.default_minutes}}"/></td>
            <td class="rowHours">0.0</td>
          </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="3" style="text-align:right">Total tid</th>
          <th id="totalHours">0.0</th>
        </tr>
      </tfoot>
    </table>
    </div>

    <button class="btn primary" type="submit">Skapa projekt</button>
  </form>
</div>

<script>
(function(){
  function updateMode(){
    const mode = (document.querySelector('input[name="mode"]:checked')||{}).value || 'budget';
    document.getElementById('budgetBox').style.display = (mode==='budget') ? 'block' : 'none';
    document.getElementById('unitsBox').style.display = (mode==='units') ? 'block' : 'none';
  }
  document.querySelectorAll('input[name="mode"]').forEach(r => r.addEventListener('change', updateMode));
  function recalc(){
    let total = 0;
    document.querySelectorAll("tr").forEach(tr => {
      const q = tr.querySelector("input.qty");
      const cell = tr.querySelector(".rowHours");
      if(!q || !cell) return;
      const mins = parseInt(q.getAttribute("data-min")||"0", 10);
      const qty = parseInt(q.value||"0", 10);
      const hours = (mins*qty)/60.0;
      cell.textContent = hours.toFixed(1);
      total += hours;
    });
    document.getElementById("totalHours").textContent = total.toFixed(1);
  }
  document.querySelectorAll("input.qty").forEach(inp => inp.addEventListener("input", recalc));
  recalc();
  updateMode();
})();
</script>
</body>
</html>
