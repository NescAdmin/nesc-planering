<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>{{wi.title}}</title>
  <link rel="stylesheet" href="/static/css/app.css"/>
</head>
<body>
<div class="topbar">
  <div class="brand">Planner MVP</div>
  <div class="nav">
    <a href="/">Resursvy</a>
    <a href="/projects">Projekt</a>
    <a href="/projects/{{project.id}}">Tillbaka till projekt</a>
  </div>
  <div class="user">Inloggad (dev): {{active_user.name}} (#{{active_user.id}})</div>
</div>

<div class="container">
  <h1>{{wi.title}}</h1>
  <p class="muted">Enhetstyp: {{ut.icon}} {{ut.name}} | Antal: {{wi.quantity}} | Tid/enhet: {{wi.minutes_per_unit}} min | Total: {{wi.total_minutes//60}}h</p>

  <div class="panel">
    <h2>Planerade block</h2>
    <ul>
      {% for b in blocks %}
        <li>{{b.start.isoformat(sep=" ", timespec="minutes")}} → {{b.end.isoformat(sep=" ", timespec="minutes")}} (person_id={{b.person_id}})</li>
      {% endfor %}
      {% if blocks|length == 0 %}
        <li class="muted">Inga block ännu. Använd Autofördela i projektsidan.</li>
      {% endif %}
    </ul>
  </div>

  <div class="panel">
    <h2>Diskussion</h2>
    <form method="post" action="/workitems/{{wi.id}}/comment">
      <textarea name="body" rows="3" placeholder="Skriv kommentar..." required></textarea>
      <button type="submit">Skicka</button>
    </form>
    <div class="comments">
      {% for c in comments %}
        <div class="comment">
          {% if c.author_user_id %}
            <div class="muted">{{ users.get(c.author_user_id).name if users.get(c.author_user_id) else ("User "+c.author_user_id|string) }} – {{ c.created_at.isoformat(sep=" ", timespec="minutes") }}</div>
          {% else %}
            <div class="muted">Extern ({{ c.author_external_email }}) – {{ c.created_at.isoformat(sep=" ", timespec="minutes") }}</div>
          {% endif %}
          <div>{{ c.body }}</div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>
</body>
</html>
